VPATH=%VPATH%

RUST ?= rust
RUSTC ?= rustc
RUSTFLAGS ?= -O
HOST_RUSTFLAGS ?= -O
VERSION=0.1-pre

libhttp_files=$(shell find $(VPATH)/src/http/ -type f -name '*.rs') \
		      $(VPATH)/src/http/generated/read_method.rs \
		      $(VPATH)/src/http/generated/status.rs

all: libhttp.dummy

codegen: $(wildcard $(VPATH)/src/codegen/*.rs)
	$(RUSTC) $(HOST_RUSTFLAGS) $(VPATH)/src/codegen/main.rs -o codegen

$(VPATH)/src/http/generated/%.rs: codegen
	./codegen $(patsubst $(VPATH)/src/http/generated/%,%,$@) $(VPATH)/src/http/generated/

libhttp.dummy: $(libhttp_files)
	$(RUSTC) $(RUSTFLAGS) $(VPATH)/src/http/lib.rs --out-dir . --lib
	touch $@

check: tests
	./tests --test

tests: $(libhttp_files)
	$(RUSTC) $(RUSTFLAGS) --test -o tests $(VPATH)/src/http/lib.rs

clean-tests:
	rm -f tests

clean: clean-tests
	rm -rf $(VPATH)src/http/generated/ codegen
	rm -rf libhttp.dummy
	rm -f *.so *.dylib *.dll

.PHONY: all examples clean clean-tests
